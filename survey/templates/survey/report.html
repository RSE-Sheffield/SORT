{% extends 'base_manager.html' %}
{% load static %}
{% load vite_integration %}
{% load django_bootstrap5 %}
{% block title %}Report for {{ survey }}{% endblock %}
{% block content %}
    <div class="container">
        <h1><i class='bx bxs-report'></i> Report: {{ survey.name }}</h1>
        <p>{{ survey.description }}</p>

        <div class="mb-3">
            <div class="sort-report-app"
                 data-json-config-id="configData"
                 data-json-responses-id="responsesData"></div>
            <h2><i class='bx bx-collection'></i> Supporting Evidence</h2>
            <p>
                This section presents the supporting evidence to <strong>contextualize the assessment</strong> findings
                and provide stakeholders with a comprehensive understanding of your organization's research readiness.
            </p>
            <p>
                For each section, evidence statements and supporting documentation have been provided to corroborate
                survey findings and offer additional context for interpreting maturity levels.
            </p>
            <ul>
                {% for section in sections %}
                    {% if section.section_config.type != "consent" %}
                        <li><a href="#page-section-{{ forloop.counter0 }}">{{ section.section_config.title }}</a></li>
                    {% endif %}
                {% endfor %}
            </ul>

            {% for section in sections %}
                {% if section.section_config.type != "consent" %}
                    <div class="page-break"></div>
                    <div>
                        <h3 id="page-section-{{ forloop.counter0 }}">Section {{ section.section_config.title }}</h3>
                        <p>{{ section.section_config.description }}</p>
                    </div>
                    <div>
                        {% if section.evidence %}
                            <h4>Evidence statement</h4>
                            <div class="sort-richtext-field"
                                 data-update-url="{% url 'survey_evidence_gathering_update' survey.id forloop.counter0 %}"
                                 data-init-contents="{{ section.evidence.text }}" data-view-only="true"></div>
                        {% endif %}

                        {% if section.improvement %}
                            <h4>Improvement plan</h4>
                            <p>
                                In the table below, list a plan of action you intend to take in the upcoming period
                                using <abbr title="Specific, Measurable, Achievable, Relevant and Time-bound">SMART
                                objectives</abbr>.
                            </p>
                            <div class="sort-smart-table" data-update-url="{{ update_url }}"
                                 data-plan="{{ section.improvement.plan|default:'[]' }}" data-view-only="true"></div>
                        {% endif %}

                    </div>
                {% endif %}
            {% endfor %}


        </div>


        {{ csrf | json_script:"csrf" }}
        {{ files_list | json_script:"filesListData" }}
        {{ survey.survey_config | json_script:"configData" }}
        {{ responses | json_script:"responsesData" }}
        {{ readiness_descriptions | json_script:"readinessDescriptions" }}
        {% vite_client %}
        {% vite_asset "src/main.ts" %}

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
{% block end_content %}
    <style media="print">
        @media print {
            *,
            *::before,
            *::after {
                text-shadow: none !important;
                box-shadow: none !important;
            }

            a:not(.btn) {
                text-decoration: underline;
            }

            abbr[title]::after {
                content: " (" attr(title) ")";
            }

            pre {
                white-space: pre-wrap !important;
            }

            pre,
            blockquote {
                border: 1px solid #adb5bd;
                page-break-inside: avoid;
            }

            tr,
            img {
                page-break-inside: avoid;
            }

            p,
            h2,
            h3 {
                orphans: 3;
                widows: 3;
            }

            h2,
            h3 {
                page-break-after: avoid;
            }

            @page {
                size: a3;
            }

            body {
                min-width: 992px !important;
                background: #fff;
            }

            .page-break {
                break-before: always;
            }

            .container {
                min-width: 992px !important;
            }

            .badge {
                border: 1px solid #000;
            }

            .table {
                border-collapse: collapse !important;
            }

            .table td,
            .table th {
                background-color: #fff !important;
            }

            .table-bordered th,
            .table-bordered td {
                border: 1px solid #dee2e6 !important;
            }

            .table-dark {
                color: inherit;
            }

            .table-dark th,
            .table-dark td,
            .table-dark thead th,
            .table-dark tbody + tbody {
                border-color: #dee2e6;
            }

            nav {
                display: none !important;
            }

            .sorting-control {
                display: none !important;
            }

            /* Hide filter card specifically by targeting cards with form controls */
            .survey-report-container .card:has(.form-label:first-of-type),
            .survey-report-container .card:has(.form-select),
            .survey-report-container .card:has(.form-range) {
                display: none !important;
            }

            /* Hide alert boxes that show filter status */
            .survey-report-container .alert-info,
            .survey-report-container .alert-warning {
                display: none !important;
            }

            /* Hide all buttons (including filter buttons) */
            .survey-report-container button {
                display: none !important;
            }

            /* Hide the response count text */
            .survey-report-container > .mb-3:has(strong) {
                display: none !important;
            }

            /* Ensure charts and visualizations are visible and print correctly */
            canvas {
                display: block !important;
                max-width: 100% !important;
                width: auto !important;
                height: auto !important;
                page-break-inside: avoid;
            }

            /* Ensure chart parent containers are visible */
            .survey-report-container .card:not(:has(.form-label)),
            .survey-report-container .card:not(:has(.form-select)),
            .survey-report-container .card:not(:has(.form-range)) {
                display: block !important;
                page-break-inside: avoid;
                background-color: #fff !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            .survey-report-container .card-body {
                display: block !important;
                width: 100% !important;
            }

            .survey-report-container .card-body > div {
                display: block !important;
                width: 100% !important;
                min-height: 400px !important;
            }

            .survey-report-container .card-header {
                display: block !important;
                background-color: #f8f9fa !important;
                border-bottom: 1px solid #dee2e6 !important;
            }

            /* Ensure flex containers display as block for printing */
            .survey-report-container .d-flex {
                display: block !important;
            }

            /* Fix pie chart containers specifically */
            .survey-report-container .w-50 {
                width: 100% !important;
                max-width: 600px !important;
                margin-left: auto !important;
                margin-right: auto !important;
            }

            /* Ensure chart wrapper divs maintain proper dimensions */
            .survey-report-container .card-body canvas {
                min-height: 300px !important;
                margin: 0 auto !important;
            }
        }

    </style>
    <style>
        /* Ensure Chart.js canvases render before print */
        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }
    </style>
{% endblock %}



