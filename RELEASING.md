# Release Process

This document describes how to create releases for the SORT project.

## Overview

SORT uses **semantic versioning** (MAJOR.MINOR.PATCH) with **fully automated releases** using semantic-release. Releases are automatically created when code is merged to `main` based on commit message conventions.

- **Automated Versioning**: semantic-release automatically determines version bumps from commit messages
- **Automatic Updates**: VERSION file, package.json, and CHANGELOG.md are automatically updated
- **Release Artifacts**: Built frontend assets and source archives are attached to releases
- **No Manual Steps**: No need to manually bump versions or create releases

## Versioning Strategy

SORT follows [Semantic Versioning 2.0.0](https://semver.org/):

- **MAJOR** version: Incompatible API changes or major feature overhauls
- **MINOR** version: New features in a backwards-compatible manner
- **PATCH** version: Backwards-compatible bug fixes

## Release Workflow

### Fully Automated Releases

When you merge a PR to `main`, semantic-release will:

1. **Analyze commits** since the last release to determine version bump type
2. **Build frontend assets** with Vite
3. **Update version** in VERSION file and package.json automatically
4. **Generate CHANGELOG.md** with release notes
5. **Commit version changes** back to main (tagged `[skip ci]`)
6. **Create git tag** (e.g., v0.2.0)
7. **Create GitHub release** with:
   - Built frontend assets (`sort-frontend-{version}.tar.gz`)
   - Complete source archive (`SORT-{version}.tar.gz`)
   - Auto-generated release notes

**No manual version bumping required!** The version is determined automatically from your commit messages.

### Commit Message Format

Use [Conventional Commits](https://www.conventionalcommits.org/) format to trigger releases:

**Version Bump Types:**
- `feat:` or `feature:` → **Minor** version bump (0.1.0 → 0.2.0)
- `fix:` → **Patch** version bump (0.1.0 → 0.1.1)
- `BREAKING CHANGE:` in footer → **Major** version bump (0.1.0 → 1.0.0)
- `docs:`, `refactor:`, `perf:` → **Patch** version bump
- `chore:`, `test:`, `build:`, `ci:` → **No release**

**Examples:**

```bash
# Minor release (new feature)
git commit -m "feat: Add evidence file upload functionality"

# Patch release (bug fix)
git commit -m "fix: Correct survey response validation for optional fields"

# Patch release (performance improvement)
git commit -m "perf: Optimize database queries for large surveys"

# No release (chore)
git commit -m "chore: Update dependencies"

# Major release (breaking change)
git commit -m "feat: Redesign survey configuration API

BREAKING CHANGE: Survey configuration endpoint now requires authentication"
```

### Manual Release Trigger

You can manually trigger the release workflow from the GitHub Actions UI:

1. Go to **Actions** → **Create Release** workflow
2. Click **Run workflow**
3. Click **Run workflow** again

This is useful for:
- Re-running a failed release
- Triggering a release after fixing CI issues

## Release Artifacts

Each release includes:

### 1. Frontend Assets (`sort-frontend-{version}.tar.gz`)
Built Vite/Svelte bundle ready for production deployment. Extract to `static/ui-components/`.

### 2. Source Archive (`SORT-{version}.tar.gz`)
Complete source code with built frontend assets included.

## Release Notes

Release notes are automatically generated by semantic-release and added to:
- GitHub release page
- CHANGELOG.md file in the repository

For better release notes:

- Use descriptive commit messages that explain **what** and **why**
- Follow the conventional commit format strictly
- Use the commit body for additional context if needed:
  ```bash
  git commit -m "feat: Add evidence file upload

  Users can now upload PDF and image files as evidence for survey responses.
  Files are validated for size (max 10MB) and type."
  ```

## Example Release Workflow

### Scenario: Feature Release (Minor Version)

```bash
# Create feature branch
git checkout -b feat/evidence-upload

# Implement new feature
# ... make changes ...
git commit -m "feat: Add evidence file upload functionality"
git push origin feat/evidence-upload

# Create PR to main
# Once merged to main, semantic-release automatically:
# 1. Detects "feat:" commit → bumps minor version (0.1.5 → 0.2.0)
# 2. Updates VERSION file and package.json
# 3. Generates CHANGELOG.md entry
# 4. Creates release v0.2.0
```

### Scenario: Hotfix Release (Patch Version)

```bash
# Create hotfix branch from main
git checkout main
git pull
git checkout -b fix/validation-bug

# Fix the bug
# ... fix bug ...
git commit -m "fix: Correct survey response validation for optional fields"
git push origin fix/validation-bug

# Create PR to main
# Once merged to main, semantic-release automatically:
# 1. Detects "fix:" commit → bumps patch version (0.2.0 → 0.2.1)
# 2. Updates VERSION file and package.json
# 3. Generates CHANGELOG.md entry
# 4. Creates release v0.2.1
```

### Scenario: Multiple Commits in One PR

```bash
# Feature branch with multiple commits
git checkout -b feat/survey-improvements

git commit -m "feat: Add survey preview mode"
git commit -m "fix: Correct date formatting in reports"
git commit -m "docs: Update survey configuration guide"
git commit -m "chore: Update test fixtures"

git push origin feat/survey-improvements

# Create PR to main
# Once merged, semantic-release automatically:
# 1. Analyzes all commits since last release
# 2. Highest priority type wins: feat > fix > docs > chore
# 3. "feat:" found → bumps minor version (0.2.1 → 0.3.0)
# 4. CHANGELOG includes all commits
```

## Rollback

If a release has issues:

1. **Revert the problematic commits** on main:
   ```bash
   git revert <commit-hash>
   git push origin main
   ```

2. A new release will be automatically created with the revert

3. Optionally **delete the problematic release** from GitHub UI (Releases page)

## Troubleshooting

### No release created after merge
**Possible causes:**
- Only `chore:`, `test:`, `ci:`, or `build:` commits since last release
- Commit messages don't follow conventional format
- All commits since last release are invalid

**Solution:** Check commit messages follow conventional format. Use `feat:` or `fix:` to trigger a release.

### semantic-release fails
**Check GitHub Actions logs for:**
- Authentication errors (verify GITHUB_TOKEN permissions)
- Build failures (ensure `npm run build` succeeds locally)
- Git configuration issues

### VERSION file out of sync with package.json
**Should never happen** - semantic-release updates both atomically. If they're out of sync:
1. Manually sync them to match the last git tag
2. Commit with `chore: sync version files [skip ci]`
3. Next release will maintain sync

### Want to skip a release
Use `[skip release]` or `[skip ci]` in commit message:
```bash
git commit -m "chore: update documentation [skip ci]"
```

## Notes

- **Use conventional commits** - this is how semantic-release determines version bumps
- **Never push directly to main** - always use PRs through feature branches
- **Review release notes** after creation and edit if needed via GitHub UI
- **Tag format**: All releases are tagged as `v{VERSION}` (e.g., v1.0.0)
- **No release commits**: Merges with only `chore:`, `test:`, `ci:`, or `build:` commits won't create a release
- **Version files are auto-updated**: semantic-release commits VERSION, package.json, and CHANGELOG.md changes back to main

## How It Works

**semantic-release workflow:**

1. **Commit Analysis**: Parses all commits since last release
2. **Version Calculation**: Determines next version based on commit types
3. **Changelog Generation**: Creates CHANGELOG.md entries from commits
4. **Version Update**: Updates VERSION file and package.json
5. **Git Operations**: Commits changes, creates tag
6. **GitHub Release**: Creates release with artifacts and notes

**Version determination logic:**
- Any `feat:` or `feature:` commit → Minor bump
- Any `fix:`, `perf:`, `refactor:`, or `docs:` commit → Patch bump
- `BREAKING CHANGE:` footer → Major bump
- Only `chore:`, `test:`, `build:`, `ci:` → No release

## Future Enhancements

Potential improvements to consider:

- [ ] Docker image builds and publication to GitHub Container Registry
- [ ] Pre-release/beta releases for testing
- [ ] Deployment automation to staging/production environments
- [ ] Slack/email notifications for new releases
- [ ] Automated dependency updates with release notes
